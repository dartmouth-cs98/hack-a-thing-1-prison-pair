<html>

<head>
	<link rel = "stylesheet" type = "text/css" href = "style.css">
</head>

<canvas id="Canvas" width="700px" height="500px" style="border:1px solid #000000;">No canvas support</canvas>

<script>
	var canvas = document.getElementById("Canvas");
	var ctx = canvas.getContext("2d");
	var x = 30;
	var y = 0;
	var rightPressed = false;
	var leftPressed = false;
	var downPressed = false;
	var upPressed = false;
	var playerX = 0;
	var playerY = 0;
	var playerXI = 0;
	var playerYI = 0;
	var map = [];
	const MAX_ROOM_SIZE = 15;
	const MIN_ROOM_SIZE = 4;
	const MAX_ROOM_DIM = 4;
	const MIN_ROOM_DIM = 2;
	const COLS = 1000;
	const ROWS = 1000;
	const DEATH_LIMIT = 4;
	const BIRTH_LIMIT = 3;
	const ROOMIFY_COUNT = 4;

	var mySound;
	var myMusic;
	var playx = 0;
	var playy = 0;
	var hasPlayed = false;

	function createMap() {
		var tempMap = [];
		for(var row = 0; row < ROWS; row++) {
  			tempMap.push([]);
			for(var col = 0; col < COLS; col++) {
				tempMap[row].push([]);
				if(Math.random() > .6) {
					tempMap[row][col] = 1;
				} else {
					tempMap[row][col] = 0;
				}
			}
		}
		return tempMap;
	}
	function pickPlayerLocation() {
		playerX = Math.floor((Math.random() * 10000)) + 1;
		playerY = Math.floor((Math.random() * 10000)) + 1;
		var playerCoor = [playerX, playerY];
	}
	function gameLoop() {
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		sideborder = canvas.width/20;
		upborder = canvas.height/20;
		playerMove();
		playerXI = Math.floor(playerX / 10);
		playerYI = Math.floor(playerY / 10);
		for( var i=-sideborder; i<sideborder; i++) {
			for( var j=-upborder; j<upborder; j++) {
				if( (i+playerXI < 0) || (j+playerYI < 0) || (i+playerXI >= 1000) || (j+playerYI >= 1000)) {
					ctx.beginPath();
					ctx.rect((i+sideborder)*10,(j+upborder)*10,10,10);
					ctx.fillStyle = "#fffb96";
					ctx.fill();
					ctx.closePath();
				}else if( map[(i+playerXI)][(j+playerYI)] == 1 ) {
					ctx.beginPath();
					ctx.rect((i+sideborder)*10, (j+upborder)*10, 10, 10);
					ctx.fillStyle = "#000000";
					ctx.fill();
					ctx.closePath();
				}
			}

		ctx.beginPath();
		ctx.rect((sideborder)*10, (upborder)*10,10,10);
		ctx.fillStyle = '#fffb96';
		ctx.fill();
		ctx.fillStyle = "grey";
		ctx.beginPath();
		ctx.arc(200, 200, 100, 0, 2 * Math.PI);
		ctx.rect(400, 0, -400, 400);
		ctx.fill();
		ctx.closePath();
		}
	}
	function playerMove() {
		var a = 0;
		var b = 0
		mySound = new sound("button-16.mp3");
		if (rightPressed){
			a = 1;
		}
		if (leftPressed){
			a = -1;
		}
		if (upPressed){
			b = -1;
		}
		if (downPressed){
			b = 1;
		}
		if (((playerXI + a) >= 0) && ((playerXI + a) <= 1000) && ((playerYI + b) >= 0) && ((playerYI + b) <= 1000)) {
			if (map[playerXI + a][playerYI + b] == 0) {
				playerX = playerX + a;
				playerY = playerY + b;
			}
			else{
				if(playerX == playx && playerY == playy){
					//Do nothing
				}
				else{
					playx = playerX;
					playy = playerY;
					mySound.play();
				}
			}
		}
	}
	document.addEventListener("keydown", keyDownHandler, false);
	document.addEventListener("keyup", keyUpHandler, false);
	function keyDownHandler(e) {
  	  if(e.keyCode == 39) {
  	      rightPressed = true;
  	  }
  	  else if(e.keyCode == 37) {
  	      leftPressed = true;
 	  }
  	  else if(e.keyCode == 40) {
  	      downPressed = true;
 	  }
  	  else if(e.keyCode == 38) {
  	      upPressed = true;
 	   }
	}
	function keyUpHandler(e) {
 	  if(e.keyCode == 39) {
 	       	rightPressed = false;
 	  }
	  else if(e.keyCode == 37) {
 	 	leftPressed = false;
	  }
	  else if(e.keyCode == 40) {
 	   	downPressed = false;
	  }
	  else if(e.keyCode == 38) {
 	       	upPressed = false;
	  }
	}
// Below functions use heavily from this website:
// https://gamedevelopment.tutsplus.com/tutorials/generate-random-cave-levels-using-cellular-automata--gamedev-9664
// Nothing was copy and pasted

	function countSurroundingBlocks(oldMap,x,y){
		var count = 0;
		for(var i=-1;i<2;i++){
			for(var j=-1;j<2;j++){
				var tempx = x + i
				var tempy = y + j

				if(!(i==0 && j==0)){
					if (tempx < 0 || tempx > oldMap.length-1 || tempy < 0 || tempy > oldMap.length-1){
						count++;
					}
					else if(oldMap[tempx][tempy] == 1){
						count++;
					}
				}
			}
		}
		return count;
	}
	function roomifyMap(oldMap){
		var newMap = createMap();
		for(var i=0; i<ROWS;i++){
			for(var j=0; j<COLS;j++){
				surroundCount = countSurroundingBlocks(oldMap,i,j);
				if(oldMap[i][j]==1){
					if(surroundCount<DEATH_LIMIT){
						newMap[i][j] = 0;
					}
					else{
						newMap[i][j] = 1;
					}
				}
				else{
					if(surroundCount>BIRTH_LIMIT){
						newMap[i][j] = 1;
					}
					else{
						newMap[i][j] = 0;
					}
				}
			}
		}
		return newMap;
	}

	// https://www.w3schools.com/graphics/game_sound.asp
	// Used sound from: https://www.soundjay.com/
	//									http://incompetech.com/music/royalty-free/index.html?keywords=8bit+Dungeon+Boss&Search=Search

	function sound(src) {
    this.sound = document.createElement("audio");
    this.sound.src = src;
    this.sound.setAttribute("preload", "auto");
    this.sound.setAttribute("controls", "none");
    this.sound.style.display = "none";
    document.body.appendChild(this.sound);
    this.play = function(){
        this.sound.play();
    }
    this.stop = function(){
        this.sound.pause();
    }
}
	function playBackgroundMusic(){
		myMusic = new sound("8bit.mp3")
		myMusic.play();
	}

	map = createMap();
	for(var i=0; i<ROOMIFY_COUNT; i++){
		map = roomifyMap(map);
	}
	pickPlayerLocation();
	playBackgroundMusic();
	setInterval(gameLoop, 10);
</script>

</html>
</html>
